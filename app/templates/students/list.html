{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4">Students</h1>
  <div class="d-flex gap-2">
    <a class="btn btn-sm btn-primary" href="{{ url_for('students.create_student') }}"><i class="fa fa-plus"></i> New</a>
    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('students.create_student') }}#bulk"><i class="fa fa-upload"></i> Bulk Upload</a>
  </div>
</div>

<table class="table table-sm table-striped align-middle">
  <thead>
    <tr>
      <th>&nbsp;</th>
      <th>Code</th>
      <th>Name</th>
      <th>Email</th>
      <th>Behaviour</th>  {# <-- NEW #}
      <th>Awards</th>
      <th>Quick Enrol</th>
      {% if current_user.is_authenticated and current_user.role == 'admin' %}
        <th>Edit</th>
      {% endif %}
    </tr>
  </thead>
  <tbody>
    {% for s in students %}
    <tr>
      <td>
        {% if s.avatar %}
          <img src="{{ s.avatar }}" alt="" style="width:36px;height:36px;object-fit:cover" class="rounded-circle border">
        {% else %}
          <span class="text-muted small">—</span>
        {% endif %}
      </td>

      <td>{{ s.student_code or '—' }}</td>
      <td><a href="{{ url_for('students.detail', user_id=s.id) }}">{{ s.last_name }}, {{ s.first_name }}</a></td>
      <td><a href="mailto:{{ s.email }}">{{ s.email }}</a></td>

      {# ---- NEW Behaviour cell ---- #}
      <td>
        {% set bp = behaviour_totals.get(s.id, 0) %}
        <div class="d-flex align-items-center gap-2">
          <span class="badge {{ 'bg-success' if bp>0 else ('bg-danger' if bp<0 else 'bg-secondary') }}">
            {{ '+' if bp>0 else '' }}{{ bp }} pts
          </span>
          <button type="button"
                  class="btn btn-sm btn-outline-secondary btn-behaviour-list"
                  data-user-id="{{ s.id }}"
                  data-user-name="{{ s.first_name }} {{ s.last_name }}">
            View
          </button>
        </div>
      </td>

      {# existing Awards cell you added earlier #}
      <td style="min-width:220px;">
        {% set a = award_summaries.get(s.id) %}
        {% if a and a.total %}
          <div class="small text-muted mb-1">
            {{ a.completed }}/{{ a.total }} complete{% if a.in_progress %} • {{ a.in_progress }} in progress{% endif %}
          </div>
          <div class="progress" style="height:8px;"><div class="progress-bar" role="progressbar" style="width: {{ a.percent }}%;"></div></div>
          <a class="small d-inline-block mt-1" href="{{ url_for('students.awards_progress', user_id=s.id) }}">View award progress</a>
        {% else %}
          <span class="text-muted small">No awards</span>
        {% endif %}
      </td>

      <td>
        <form method="post" action="{{ url_for('students.quick_enroll') }}" class="d-flex gap-2 align-items-center">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="user_id" value="{{ s.id }}">
          <select class="form-select form-select-sm" name="course_id" required>
            {% if courses %}
              {% for c in courses %}<option value="{{ c.id }}">{{ c.name }} {{ c.semester }}{{ c.year }}</option>{% endfor %}
            {% else %}
              <option value="" disabled>No courses available</option>
            {% endif %}
          </select>
          <button class="btn btn-sm btn-outline-success">Enrol</button>
        </form>
      </td>

      {% if current_user.is_authenticated and current_user.role == 'admin' %}
      <td><a class="btn btn-sm btn-outline-secondary" href="{{ url_for('students.edit_student', user_id=s.id) }}"><i class="fa fa-pen"></i> Edit</a></td>
      {% endif %}
    </tr>
    {% else %}
      {% set colcount = 7 + (1 if current_user.is_authenticated and current_user.role == 'admin' else 0) %}
      <tr><td colspan="{{ colcount }}" class="text-muted">No students found.</td></tr>
    {% endfor %}
  </tbody>
</table>

{# Modal skeleton (once per page) #}
<div class="modal fade" id="behaviourModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Behaviours — <span id="bhvStudentName"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="bhvBody">
        <div class="text-muted">Loading…</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
window.addEventListener('load', function() {
  const modalEl = document.getElementById('behaviourModal');
  const modal = new bootstrap.Modal(modalEl);
  const body = document.getElementById('bhvBody');
  const nameSpan = document.getElementById('bhvStudentName');

  document.querySelectorAll('.btn-behaviour-list').forEach(btn => {
    btn.addEventListener('click', async () => {
      const uid = btn.dataset.userId;
      const uname = btn.dataset.userName || 'Student';
      nameSpan.textContent = uname;
      body.innerHTML = '<div class="text-muted">Loading…</div>';
      try {
        const resp = await fetch('{{ url_for("behaviours.list_behaviours") }}?user_id=' + encodeURIComponent(uid), {
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          credentials: 'same-origin'
        });
        const html = await resp.text();
        body.innerHTML = html;
      } catch (e) {
        body.innerHTML = '<div class="text-danger">Failed to load behaviours.</div>';
      }
      modal.show();
    });
  });
});
</script>
{% endblock %}
