!function(){let t="examTimer.blocks.v1",e="examTimer.clockPos.v1",n=[],o="",l="idle",s=null,i=-1,a=0,r=0,c=0,d=0,u=0,m=!1,f=null;function p(t,e,n){return Math.max(e,Math.min(n,t))}function g(t){t=Math.max(0,Math.floor(t));let e=Math.floor(t/1e3),n=Math.floor(e/3600).toString().padStart(2,"0"),o=Math.floor(e%3600/60).toString().padStart(2,"0"),l=(e%60).toString().padStart(2,"0");return`${n}:${o}:${l}`}function b(t){let e=Math.max(0,Math.floor(+t.minutes||0)),n=Math.max(0,Math.floor(+t.seconds||0));return 6e4*e+1e3*n}function x(t){return t.reduce((t,e)=>t+b(e),0)}function h(t){if(!t)return{r:255,g:255,b:255};3===(t=t.replace("#","")).length&&(t=t.split("").map(t=>t+t).join(""));let e=parseInt(t,16);return{r:e>>16&255,g:e>>8&255,b:255&e}}function k(t="start"){if(!m)try{f||(f=new(window.AudioContext||window.webkitAudioContext));let e=f,n=e.currentTime;function o(t,o,l,s="sine",i=.1){let a=e.createOscillator(),r=e.createGain();a.type=s,a.frequency.setValueAtTime(t,n+o),a.connect(r),r.connect(e.destination),r.gain.setValueAtTime(i,n+o),r.gain.exponentialRampToValueAtTime(1e-4,n+o+l),a.start(n+o),a.stop(n+o+l)}"start"===t&&(o(880,0,.25,"square"),o(1175,.1,.25,"square")),"next"===t&&o(988,0,.18,"sine"),"end"===t&&(o(523,0,.25,"sawtooth"),o(392,.12,.4,"sawtooth"))}catch{}}function y(){try{localStorage.setItem(t,JSON.stringify({name:o,blocks:n}))}catch{}}function v(){try{let e=localStorage.getItem(t);if(e){let l=JSON.parse(e);Array.isArray(l)?(n=l,o=""):l&&"object"==typeof l&&(n=Array.isArray(l.blocks)?l.blocks:[],o="string"==typeof l.name?l.name:""),n.forEach(t=>{"number"!=typeof t.seconds&&(t.seconds=0)})}}catch{}}let _={active:!1,offsetX:0,offsetY:0};function C(t){let e=document.getElementById("clockPanel");if(!e)return;if(!e.classList.contains("draggable-fixed")){e.classList.add("draggable-fixed");let n=e.getBoundingClientRect();e.style.left=n.left+"px",e.style.top=n.top+"px",e.style.transform="none"}let o=e.getBoundingClientRect(),l=t.touches?t.touches[0]:t;_.active=!0,_.offsetX=l.clientX-o.left,_.offsetY=l.clientY-o.top,e.classList.add("dragging"),t.preventDefault()}function B(t){if(!_.active)return;let n=document.getElementById("clockPanel"),o=t.touches?t.touches[0]:t,l=o.clientX-_.offsetX,s=o.clientY-_.offsetY,i=window.innerWidth,a=window.innerHeight,r=n.getBoundingClientRect();l=Math.max(8,Math.min(i-r.width-8,l)),s=Math.max(56,Math.min(a-r.height-8,s)),n.style.left=l+"px",n.style.top=s+"px",n.style.transform="none";try{localStorage.setItem(e,JSON.stringify({left:l,top:s}))}catch{}}function w(){_.active=!1;let t=document.getElementById("clockPanel");t&&t.classList.remove("dragging")}function P(){let t=$("#tblBlocks tbody");t.empty(),n.forEach((e,n)=>{let o=$(`<tr data-id="${e.id}">
            <td class="text-center"><span class="row-drag-handle">⠿</span></td>
            <td>
              <select class="form-select form-select-sm mb-1 block-name-select" aria-label="Block name">
                <option ${"Perusal"===e.name?"selected":""}>Perusal</option>
                <option ${"Reading"===e.name?"selected":""}>Reading</option>
                <option ${"Exam"===e.name?"selected":""}>Exam</option>
                <option ${"Other"===e.name?"selected":""}>Other</option>
                <option ${["Perusal","Reading","Exam","Other"].includes(e.name)?"":"selected"} value="Custom">Custom…</option>
              </select>
              <input class="form-control form-control-sm block-name-custom ${["Perusal","Reading","Exam","Other"].includes(e.name)?"d-none":""}" value="${["Perusal","Reading","Exam","Other"].includes(e.name)?"":e.name}" placeholder="Custom name"/>
            </td>
            <td>
              <div class="input-group input-group-sm">
                <input type="number" class="form-control block-minutes" min="0" step="1" value="${Math.max(0,Math.floor(+e.minutes||0))}" />
                <span class="input-group-text">min</span>
              </div>
            </td>
            <td>
              <select class="form-select form-select-sm block-seconds" aria-label="Seconds (0/15/30/45)">
                <option value="0"  ${0==(+e.seconds||0)?"selected":""}>0</option>
                <option value="15" ${15==(+e.seconds||0)?"selected":""}>15</option>
                <option value="30" ${30==(+e.seconds||0)?"selected":""}>30</option>
                <option value="45" ${45==(+e.seconds||0)?"selected":""}>45</option>
              </select>
            </td>
            <td>
              <input type="color" class="form-control form-control-color form-control-sm block-color" value="${e.color}" title="Pick label color"/>
            </td>
            <td class="text-end">
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-secondary btn-up" title="Move up">▲</button>
                <button class="btn btn-outline-secondary btn-down" title="Move down">▼</button>
                <button class="btn btn-outline-danger btn-del" title="Delete">Delete</button>
              </div>
            </td>
          </tr>`);t.append(o)}),0===n.length&&t.append('<tr class="text-muted"><td colspan="6">No blocks yet. Click <em>Add block</em> or try the <em>Quick preset</em>.</td></tr>'),R(),E()}function E(){let t=x(n);$("#totalRemaining").text(g(t))}function R(){let t=$("#upcomingInline");t.empty(),n.length&&(n.forEach((e,n)=>{var o,l;let s=$(`<span class="chip" title="${n<i?"Finished":n===i?"Current":"Upcoming"}">
            <span class="swatch" style="background:${e.color}"></span>
            <span class="label">${e.name}</span>
            <span class="dur">${(o=e.minutes,`${Math.max(0,Math.floor(+o||0))}:${(Math.max(0,Math.floor(+(l=e.seconds)||0))%60).toString().padStart(2,"0")}`)}</span>
          </span>`);n<i&&s.addClass("done"),n===i&&s.addClass("current"),t.append(s)}),$("#upcomingSummary").text(`${n.length} block${1===n.length?"":"s"}`))}function S(){$("#btnStart").prop("disabled","idle"!==l||0===n.length||n.every(t=>0===b(t)));let t=$("#btnPauseToggle");"running"===l?t.prop("disabled",!1).text("Pause").removeClass("btn-primary").addClass("btn-outline-primary"):"paused"===l?t.prop("disabled",!1).text("Unpause").removeClass("btn-outline-primary").addClass("btn-primary"):t.prop("disabled",!0).text("Pause").removeClass("btn-primary").addClass("btn-outline-primary"),$("#btnStop").prop("disabled",!("running"===l||"paused"===l)),$("#btnReset").prop("disabled",!("paused"===l||"stopped"===l||"finished"===l)),$("#pausedMask").toggleClass("show","paused"===l)}function L(t,e){let n=g(e);"running"===l||"paused"===l?document.title=`⏱ ${o?o+" \xb7 ":""}${t} \xb7 ${n}`:document.title=o?`⏱ ${o}`:"Exam Timer",$("#currentBlockBadge").text(t||"Not started")}function I(){let t=$("#currentBlockBadge"),e=i>=0&&i<n.length?n[i]:null;if(!e){t.css({backgroundColor:"",color:"",borderColor:""});return}let o=e.color||"#0d6efd",l=function t(e){let{r:n,g:o,b:l}=h(e);return(299*n+587*o+114*l)/1e3>=140?"#000":"#fff"}(o),s=function t(e,n){let{r:o,g:l,b:s}=h(e),i=n<0?0:255,a=Math.abs(n)/100;return"#"+[Math.round((i-o)*a+o),Math.round((i-l)*a+l),Math.round((i-s)*a+s)].map(t=>t.toString(16).padStart(2,"0")).join("")}(o,-25);t.css({backgroundColor:o,color:l,borderColor:s})}function T(t){$("#endsAt").text(function t(e){if(!e)return"—";let n=new Date(e);return n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}(t))}function A(t){let e=r-t,o=r?p(e/r*100,0,100):0;$("#currentPct").text(`${o.toFixed(0)}%`),$("#currentProgress").css("width",o+"%");let s=d-function t(){if("idle"===l)return x(n);let e=0;i>=0&&i<n.length&&("paused"===l?e+=c:e+=Math.max(0,a-Date.now()));for(let o=i+1;o<n.length;o++)e+=b(n[o]);return e}(),u=d?p(s/d*100,0,100):0;$("#overallPct").text(`${u.toFixed(0)}%`),$("#overallProgress").css("width",u+"%")}function O(){$("#setupPanel").toggleClass("d-none","running"===l)}function D(){$("#timerTitle").text(o||""),$("#timerName").val(o)}function N(){if("running"!==l)return;let t=Date.now(),e=a-t;if(e<=0){!function t(){if(!(i<0)){if(R(),k(i+1<n.length?"next":"end"),++i>=n.length){clearInterval(s),s=null,l="finished",S(),O(),$("#timeRemaining").text("00:00:00"),$("#currentBlockBadge").text("Finished").css({backgroundColor:"",color:"",borderColor:""}),T(0),A(0),R(),$("#nextBlock").text("—");return}F(i)}}();return}$("#timeRemaining").text(g(e)),T(a),L(n[i]?.name||"—",e),I(),A(e),R()}function F(t){let e=n[t];r=Math.max(0,b(e)),a=Date.now()+r,$("#timeRemaining").text(g(r)),T(a),L(e.name,r),I(),A(r),R(),$("#nextBlock").text(n[t+1]?.name||"—")}function M(){!n.length||n.every(t=>0===b(t))||(n.forEach(t=>{t.minutes=Math.max(0,Math.floor(+t.minutes||0)),t.seconds=[0,15,30,45].includes(+t.seconds)?+t.seconds:0}),d=x(n),u=Date.now(),l="running",i=0,function t(){let n=document.getElementById("clockPanel");if(n){n.classList.add("draggable-fixed"),n.style.left="50%",n.style.top="50%",n.style.transform="translate(-50%, -50%)";try{localStorage.removeItem(e)}catch{}}}(),F(i),S(),O(),s&&clearInterval(s),s=setInterval(N,200),k("start"))}function X(){"running"===l&&(c=Math.max(0,a-Date.now()),clearInterval(s),s=null,l="paused",S(),O(),L((n[i]?.name||"—")+" (paused)",c),I(),T(Date.now()+c),$("#timeRemaining").text(g(c)),A(c))}function Y(){"paused"===l&&(a=Date.now()+c,c=0,l="running",S(),O(),I(),s=setInterval(N,200),N())}function j(){("running"===l||"paused"===l)&&(clearInterval(s),s=null,l="stopped",S(),O(),$("#currentBlockBadge").text("Stopped").css({backgroundColor:"",color:"",borderColor:""}),L("Stopped",0),T(0))}function q(){clearInterval(s),s=null,l="idle",i=-1,a=0,r=0,c=0,d=x(n),S(),O(),function t(){let e=document.getElementById("clockPanel");e&&(e.classList.remove("draggable-fixed","dragging"),e.style.left=e.style.top="",e.style.transform="")}(),$("#currentPct").text("0%"),$("#currentProgress").css("width","0%"),$("#overallPct").text("0%"),$("#overallProgress").css("width","0%"),$("#timeRemaining").text("00:00:00"),$("#currentBlockBadge").text("Not started").css({backgroundColor:"",color:"",borderColor:""}),$("#endsAt").text("—"),$("#nextBlock").text(n[0]?.name||"—"),$("#totalRemaining").text(g(x(n))),R(),document.title=o?`⏱ ${o}`:"Exam Timer"}function V(t="Perusal",e=10,o=0,l="#0d6efd"){n.push({id:"b"+Math.random().toString(36).slice(2,10),name:t,minutes:Math.floor(e),seconds:Math.floor(o)||0,color:l}),P(),y(),S()}function H(){n=[],V("Perusal",10,0,"#6f42c1"),V("Reading",5,0,"#20c997"),V("Exam",120,0,"#0d6efd")}$(function t(){v(),n.length||H(),P(),S(),D(),O(),$("#nextBlock").text(n[0]?.name||"—"),$("#totalRemaining").text(g(x(n))),$("#tblBlocks").on("change",".block-name-select",function(){let t=$(this).closest("tr"),e=t.data("id"),o=$(this).val();if("Custom"===o)t.find(".block-name-custom").removeClass("d-none").focus();else{t.find(".block-name-custom").addClass("d-none");let l=n.find(t=>t.id===e);l&&(l.name=o),R(),y()}}),$("#tblBlocks").on("input",".block-name-custom",function(){let t=$(this).closest("tr"),e=t.data("id"),o=n.find(t=>t.id===e);o&&(o.name=$(this).val()||"Custom"),R(),y()}),$("#tblBlocks").on("change",".block-minutes",function(){let t=$(this).closest("tr"),e=t.data("id"),o=n.find(t=>t.id===e);o&&(o.minutes=Math.max(0,Math.floor(+$(this).val()||0))),E(),R(),y(),S()}),$("#tblBlocks").on("change",".block-seconds",function(){let t=$(this).closest("tr"),e=t.data("id"),o=+$(this).val(),l=n.find(t=>t.id===e);l&&(l.seconds=[0,15,30,45].includes(o)?o:0),E(),R(),y(),S()}),$("#tblBlocks").on("change",".block-color",function(){let t=$(this).closest("tr"),e=t.data("id"),o=n.find(t=>t.id===e);o&&(o.color=$(this).val()),R(),y(),i>=0&&n[i]&&n[i].id===e&&I()}),$("#tblBlocks").on("click",".btn-del",function(){let t=$(this).closest("tr").data("id");n=n.filter(e=>e.id!==t),P(),y(),S()}),$("#tblBlocks").on("click",".btn-up",function(){let t=$(this).closest("tr").data("id"),e=n.findIndex(e=>e.id===t);if(e>0){let o=n[e-1];n[e-1]=n[e],n[e]=o,P(),y()}}),$("#tblBlocks").on("click",".btn-down",function(){let t=$(this).closest("tr").data("id"),e=n.findIndex(e=>e.id===t);if(e>=0&&e<n.length-1){let o=n[e+1];n[e+1]=n[e],n[e]=o,P(),y()}}),$(document).on("input","#timerName",function(){o=$(this).val().trim(),D(),y()}),$("#btnAddBlock").on("click",()=>V("Other",15,0,"#fd7e14")),$("#btnPreset").on("click",H),$("#btnSave").on("click",y),$("#btnLoad").on("click",()=>{v(),P(),D(),O(),S()}),$("#btnStart").on("click",M),$("#btnPauseToggle").on("click",()=>{"running"===l?X():"paused"===l&&Y()}),$("#btnStop").on("click",j),$("#btnReset").on("click",q),$("#btnMute").on("click",function(){m=!m,$(this).text(m?"\uD83D\uDD15":"\uD83D\uDD14")}),$(document).on("click","#extraTimeMenu .extra-time",function(t){var e;t.preventDefault();let o=parseInt($(this).data("mins"),10);Number.isFinite(o)&&(e=6e4*o,("running"===l||"paused"===l)&&(i<0||i>=n.length||(r+=e,d+=e,"running"===l?(a+=e,N()):(c+=e,$("#timeRemaining").text(g(c)),T(Date.now()+c),L((n[i]?.name||"—")+" (paused)",c),A(c)))));let s=$(this).closest(".btn-group").find('[data-bs-toggle="dropdown"]')[0];s&&bootstrap.Dropdown.getOrCreateInstance(s).hide()}),$("#timeRemaining").on("click",()=>{"running"===l?X():"paused"===l&&Y()}),window.addEventListener("keydown",t=>{("Space"===t.code||" "===t.key)&&!function t(e){if(!e)return!1;let n=e.tagName?.toLowerCase();return"input"===n||"textarea"===n||"select"===n||e.isContentEditable}(document.activeElement)&&("running"===l?(X(),t.preventDefault()):"paused"===l&&(Y(),t.preventDefault()))});let s=document.getElementById("clockHandle");s.addEventListener("mousedown",C),window.addEventListener("mousemove",B),window.addEventListener("mouseup",w),s.addEventListener("touchstart",C,{passive:!1}),window.addEventListener("touchmove",B,{passive:!1}),window.addEventListener("touchend",w),function t(){try{let n=JSON.parse(localStorage.getItem(e)||"null"),o=document.getElementById("clockPanel");if(!o)return;n&&"number"==typeof n.left&&"number"==typeof n.top&&(o.classList.add("draggable-fixed"),o.style.transform="none",o.style.left=n.left+"px",o.style.top=n.top+"px")}catch{}}()})}();